extends ../layout

block script
    script(type="module").
        import Quill from "quill";

        function createQuill({ id, toolbarId, placeholder, initialContent, onUpdate, onImageUpload }) {
            const quill = new Quill(`#${id}`, {
                modules: { toolbar: `#${toolbarId}` }
            });

            quill.root.setAttribute("placeholder", placeholder);
            quill.setContents(initialContent);

            quill.getModule("toolbar").addHandler("image", () => {
                const input = document.createElement("input");

                input.setAttribute("type", "file");
                input.setAttribute("accept", "image/*");

                input.click();

                input.onchange = async () => {
                    const file = input.files[0];
                    const filePath = await onImageUpload(file);

                    if (filePath) {
                        const range = quill.getSelection();
                        quill.insertEmbed(range.index, "image", filePath);
                    }
                }
            });

            quill.on("text-change", (delta, oldDelta, source) => {
                if (source === "user") {
                    onUpdate(quill.getContents());
                }
            });

            return quill;
        }

        Alpine.data("editor", function () {
            return {
                unlocked: false,

                init() {
                    const id = Number(this.$params.id);
                    this.note = this.$store.notes.get(id);

                    if (!this.note) {
                        setTimeout(() => this.$router.navigate("/"));
                        notyf.error("The note you're looking for isn't here, but we believe in you!");
                    } else if (this.note.password) {
                        // Next tick in order to show the password prompt properly
                        this.$nextTick(() => this.$dispatch("prompt-unlock", {
                            noteId: this.note.id,
                            onSuccess: () => this.createEditor(),
                            onClose: () => {
                                if (!this.unlocked) {
                                    this.$router.navigate("/");
                                }
                            }
                        }));
                    } else {
                        this.createEditor();
                    }
                },

                createEditor() {
                    const quill = createQuill({
                        id: "editor",
                        toolbarId: "editor-toolbar",
                        placeholder: "Write something legendary! Or just your grocery list...",
                        initialContent: this.note.content,
                        onChange: (content) => this.$dispatch("update-note", content.ops),
                        onImageUpload: async (file) => {
                            const path = await uploadImage(file);
                            return path ? `${API_URL}/api/${path}` : null;
                        }
                    });

                    this.unlocked = true;

                    quill.focus();
                }
            }
        });

block header-left
    a.btn-icon(type="button", x-ref="closeEditor", href="/")
        i.fa.fa-arrow-left

block content
    #editor-container(x-data="editor").flex-1.flex
        .flex.flex-col.gap-4.w-full.max-w-4xl.p-4.mx-auto(
            x-show="unlocked",
            @update-note.debounce.2s=`
                $store.notes.update($params.id, {
                    content: JSON.stringify($event.detail)
                })
            `
        )
            #editor-toolbar-overflow.overflow-x-auto
                #editor-toolbar.w-max.flex.justify-center.items-center.p-2.mx-auto
                    select.ql-header.form-input(class="!w-40 !mt-0")
                        each h in [1, 2, 3]
                            option(value=h) Heading #{h}
                        option(selected) Body

                    .px-2

                    -
                        const formats = {
                            bold: {}, italic: {}, underline: {},
                            strike: { icon: "strikethrough" }
                        }

                    each [format, options] of Object.entries(formats)
                        button.btn-icon(type="button", class=`ql-${format}`)
                            i.fa(class=`fa-${options.icon || format}`)

                    .px-2

                    -
                        const aligns = {
                            "": { icon: "left" },
                            justify: {}, center: {}, right: {}
                        }

                    each [align, options] of Object.entries(aligns)
                        button.ql-align.btn-icon(type="button", value=align)
                            i.fa(class=`fa-align-${options.icon || align}`)

                    .px-2

                    button.ql-image.btn-icon(type="button")
                        i.fa.fa-image

                    .px-2

                    +note-more-options

            #note-title
                input.form-input.text-2xl.font-bold.p-5(
                    type="text",
                    :value="typeof note !== 'undefined' ? note.title : ''",
                    placeholder="Note title",
                    class="dark:!bg-gray-900",
                    @input.debounce.2s=`$store.notes.update(
                        $params.id, { title: $el.value }
                    )`
                )

            #editor

        .flex-1.flex.justify-center.items-center(x-show="!unlocked")
            .spinner.scale-200